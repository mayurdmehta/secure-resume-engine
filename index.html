<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Tailoring Engine ✨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose h1 { font-size: 1.875rem; font-weight: 700; margin-bottom: 1rem; }
        .prose h2 { font-size: 1.5rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        .prose h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; line-height: 1.6; }
        .prose ul { list-style-position: inside; padding-left: 0; }
        .prose li { margin-bottom: 0.5rem; }
        .prose strong { font-weight: 600; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; max-width: 90%; width: 600px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Resume Tailoring Engine ✨</h1>
            <p class="text-lg text-gray-600 mt-2">Your AI-powered career assistant.</p>
        </header>
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. Paste Job Description</h2>
                <textarea id="jobDescription" class="w-full h-96 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="Paste the full job description here..."></textarea>
                <div class="flex space-x-4 mt-4">
                    <button id="analyzeBtn" class="w-1/2 bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-200 flex items-center justify-center disabled:bg-gray-400">✨ Analyze Job</button>
                    <button id="generateBtn" class="w-1/2 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 flex items-center justify-center disabled:bg-gray-400">Generate Resume</button>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">2. Generated Content</h2>
                    <button id="copyBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-200 hidden">Copy</button>
                </div>
                <div id="loader" class="hidden flex justify-center items-center h-full"><div class="loader"></div></div>
                <div id="resumeOutput" class="prose max-w-none flex-grow overflow-y-auto p-4 border border-gray-200 rounded-lg"><p class="text-gray-500">Your tailored resume will appear here...</p></div>
                <div id="nextSteps" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-xl font-semibold text-blue-800 mb-3">Next Steps ✨</h3>
                    <div class="flex space-x-4">
                        <button id="coverLetterBtn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200">Draft Cover Letter</button>
                        <button id="interviewPrepBtn" class="flex-1 bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200">Interview Prep</button>
                    </div>
                </div>
                <div id="error-message" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg"></div>
            </div>
        </main>
    </div>
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-2xl font-semibold"></h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modalLoader" class="hidden flex justify-center items-center py-16"><div class="loader"></div></div>
            <div id="modalBody" class="prose max-w-none"></div>
        </div>
    </div>
    <script type="module">
        // --- DOM ELEMENTS ---
        const generateBtn = document.getElementById('generateBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const jobDescriptionInput = document.getElementById('jobDescription');
        const resumeOutput = document.getElementById('resumeOutput');
        const loader = document.getElementById('loader');
        const copyBtn = document.getElementById('copyBtn');
        const errorMessageDiv = document.getElementById('error-message');
        const nextSteps = document.getElementById('nextSteps');
        const coverLetterBtn = document.getElementById('coverLetterBtn');
        const interviewPrepBtn = document.getElementById('interviewPrepBtn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalLoader = document.getElementById('modalLoader');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // --- EVENT LISTENERS ---
        generateBtn.addEventListener('click', () => callBackend('resume'));
        analyzeBtn.addEventListener('click', () => callBackend('analyze'));
        coverLetterBtn.addEventListener('click', () => callBackend('coverLetter'));
        interviewPrepBtn.addEventListener('click', () => callBackend('interviewPrep'));
        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

        // --- CORE LOGIC ---
        async function callBackend(mode) {
            const jobDescription = jobDescriptionInput.value;
            if (!jobDescription.trim()) {
                showError("Please paste a job description.");
                return;
            }

            let resumeTextForFeatures = "";
            if (mode === 'coverLetter' || mode === 'interviewPrep') {
                resumeTextForFeatures = resumeOutput.innerText;
                openModal(mode === 'coverLetter' ? "✨ Cover Letter Draft" : "✨ Interview Prep Questions");
            } else {
                setLoading(true);
            }

            try {
                const backendUrl = '/.netlify/functions/gemini'; 
                
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        mode, 
                        jobDescription, 
                        resumeText: resumeTextForFeatures 
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Backend Error:", errorBody);
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const resultText = await response.text();

                if (mode === 'coverLetter' || mode === 'interviewPrep') {
                    modalBody.innerHTML = formatForDisplay(resultText);
                    modalLoader.classList.add('hidden');
                } else {
                    resumeOutput.innerHTML = formatForDisplay(resultText);
                    copyBtn.classList.remove('hidden');
                    if (mode === 'resume') {
                        nextSteps.classList.remove('hidden');
                    } else {
                        nextSteps.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error("Error:", error);
                if (mode === 'coverLetter' || mode === 'interviewPrep') {
                     modalBody.innerHTML = `<p class="text-red-500">Failed to generate content. Please try again.</p>`;
                     modalLoader.classList.add('hidden');
                } else {
                    showError("Sorry, an error occurred. Please try again.");
                }
            } finally {
                if (mode !== 'coverLetter' && mode !== 'interviewPrep') {
                    setLoading(false);
                }
            }
        }

        function formatForDisplay(text) {
             let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
             html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>').replace(/^## (.*$)/gim, '<h2>$1</h2>').replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^\* (.*$)/gim, '<li>$1</li>');
             html = html.replace(/<li>/g, '<ul><li>').replace(/<\/li>/g, '</li></ul>').replace(/<\/ul>\s*<ul>/g, '');
             html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             return html.replace(/\n/g, '<br>');
        }

        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            analyzeBtn.disabled = isLoading;
            if (isLoading) {
                resumeOutput.classList.add('hidden');
                loader.classList.remove('hidden');
                errorMessageDiv.classList.add('hidden');
                nextSteps.classList.add('hidden');
            } else {
                resumeOutput.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }
        
        function openModal(title) {
            modalTitle.textContent = title;
            modal.classList.remove('hidden');
            modalBody.innerHTML = '';
            modalLoader.classList.remove('hidden');
        }

        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        function copyToClipboard() {
            const textToCopy = resumeOutput.innerText;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); copyBtn.textContent = 'Copied!'; setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000); } 
            catch (err) { console.error('Failed to copy text: ', err); showError("Failed to copy text."); }
            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>