// --- MASTER PROFILE DATABASE ---
// The database now lives securely inside the backend function.
const masterProfile = {"contactInfo":{"name":"Mayur Mehta","phone":"+1 (571) 528-7448","email":"mayurdmehta@gmail.com","location":"Nashua, NH","linkedin":"[LinkedIn Profile URL]"},"experience":[{"company":"Robert Half","title":"Senior Business Systems Analyst","dates":"Dec 2022 – Mar 2025","accomplishments":[{"id":"RH01","summary":"Unified siloed global marketing teams by creating and implementing a standardized data governance framework for a $20M annual marketing spend. Owned the project end-to-end, from gathering cross-functional requirements to configuring the utm.io platform and leading the change management, training, and onboarding for over 200 stakeholders, ultimately boosting platform adoption by 150% and reducing data inconsistencies by 30%."},{"id":"RH02","summary":"Resolved team inefficiency by designing and implementing a new engagement model and automated intake process for the Global Marketing Analytics team. Partnered with PMO, business, and technical stakeholders to replace an ad-hoc system with a streamlined Jira/Smartsheet workflow, reducing the request lifecycle from 2 weeks to 3 days and freeing up engineering resources."},{"id":"RH03","summary":"Owned the Invoca call intelligence platform to provide sales performance and customer sentiment insights. Partnered with Invoca's data science team to co-develop and train NLP models, using confusion matrix testing to achieve 90% classification accuracy. Drove the strategy to integrate this data into closed-loop reporting and ad platforms (Google Ads) to optimize marketing spend."},{"id":"RH04","summary":"Served as the central operational leader for a 40-member Global Marketing Analytics team, orchestrating work across four verticals (Data Strategy, QA, Data Engineering, BI). Owned the team's backlog, managed resource allocation, and aligned execution with leadership's strategic priorities for a $20M marketing spend, increasing overall team efficiency by 30%."},{"id":"RH05","summary":"Led the project to migrate the 200+ user Global Marketing Confluence instance into the enterprise SSO environment. Owned the end-to-end process, including the seamless migration of 100GB+ of data, user training, and administration, completing the project ahead of schedule with zero disruption to user access or permissions."}]},{"company":"LilacMosaic Technologies","title":"Co-Founder / Lead Business Analyst","dates":"Aug 2023 – Jan 2025","accomplishments":[{"id":"LM01","summary":"As co-founder, drove the end-to-end product discovery and strategy for an AI-driven event planning platform. Conducted 15+ user interviews and 10+ surveys to create foundational artifacts (personas, journey maps, JTBD), defined the product roadmap, and owned the prioritized engineering backlog."},{"id":"LM02","summary":"Oversaw the integration of Hugging Face (GenAI) and Pinterest APIs to build a core AI design recommendation engine. Drove the technical execution and launched the feature to 10+ beta customers, establishing a rapid feedback loop for continuous improvement and mentoring junior team members on Agile practices."},{"id":"LM03","summary":"Enabled a nimble startup team to thrive in a fluid environment by introducing Agile (Scrum) practices. Coached the team on using iterative development and continuous feedback to adapt to constantly changing requirements, increasing the speed of value delivery to customers."}]},{"company":"Akamai Technologies","title":"Business Systems Analyst","dates":"Sep 2019 – Dec 2022","accomplishments":[{"id":"AK01","summary":"Led a 7-phase global program to modernize Akamai's tax automation by migrating from Oracle EBTax to Thomson Reuters OneSource, impacting $1B in annual spend. Owned the full SDLC, from learning and configuring the new SaaS platform to translating complex international tax laws into technical requirements and managing the complex integration with Oracle EBS, delivering $4M in efficiency savings."},{"id":"AK02","summary":"Drove a complex, SOX-compliant expense system modernization by integrating SAP Concur, Amex, and the AppZen AI compliance engine with Oracle EBS. Led the migration of 20+ operational reports to Cognos BI, and implemented the AppZen ML model to automate 99% of compliance checks, improving on-time reporting by 20%."},{"id":"AK03","summary":"Automated the transmission of $1B in annual vendor payments by designing and leading the implementation of a highly available host-to-host XML system with banking partners (Chase, Citi). Authored all technical documentation (BRD, FRD, TDD, BR100) and managed the full SDLC, delivering a robust system with a 99.99% successful payment completion rate."},{"id":"AK04","summary":"Increased cross-functional operational efficiency by 25% by owning the Procure-to-Pay modules in Oracle EBS. Partnered with DevOps on root cause analysis and used SQL-based analysis to drive data-driven prioritization, balancing the business backlog against critical technical debt. Created Tableau dashboards to give leadership visibility, enabling the successful delivery of multiple large-scale projects while improving operational stability."}]}],"education":[{"institution":"Northeastern University","degree":"Master of Science, Engineering Management","gpa":"3.9"},{"institution":"University of Mumbai","degree":"Bachelor of Science, Computer Science"}],"certifications":[{"name":"Certified Scrum Master (CSM)","issuer":"Scrum Alliance","status":"Completed: Apr 2025"},{"name":"AWS Certified Cloud Practitioner","issuer":"AWS","status":"In Progress, Expected: Jul 2025"},{"name":"Project Management Professional (PMP)","issuer":"PMI","status":"In Progress, Expected: Aug 2025"}],"skills_master_list":["Agile","Scrum","Kanban","Waterfall","SDLC","Agile Coaching (for adaptability)","Scrum Implementation","Facilitation","Iterative Development","Value-Driven Delivery","Quote-to-Cash (QTC)","Procure-to-Pay","Sales Operations","Financial Systems","Payment Systems Automation","Host-to-Host Transmission (XML)","Process Reengineering","Process Improvement (from scratch)","Process Optimization","Process Analysis","Workflow Automation","Process Implementation (for flexibility)","Process Automation","Requirements Gathering","BRDs","FRDs","User Stories","User Story Mapping","Gap Analysis","Technical Documentation (BRD, FRD, TDD, BR100)","Stakeholder Management","Stakeholder Alignment","Cross-functional Leadership","Stakeholder Partnership","DevOps Partnership","Change Management (Startup)","Risk Management","Dependency Management","Engagement Model Design","Requirements Scoping","Risk Mitigation","Regulatory Compliance","AI/ML","NLP","AI Use Case Identification","AI Governance","AI/ML Platform Management (Invoca)","Sentiment Analysis","Model Evaluation (Confusion Matrix)","Data Integration Strategy","Marketing Analytics","Ad Optimization","Closed-Loop Reporting","Generative AI","AI/ML Implementation (AppZen)","Operational Management","Program Management","Backlog Management","Resource Planning","Execution Oversight","Cross-functional Orchestration","Strategic Prioritization","Data-Driven Prioritization","Functional Ownership (Oracle P2P)","Technical Debt Management","Root Cause Analysis","Data Analysis","Data Governance","Data Standardization","Dashboarding","BI Dashboarding (Tableau)","Technical Project Management","Data Migration","Identity & Access Management (SSO)","System Administration (Confluence)","Product Discovery","User Research","Product Strategy","User Personas","Journey Mapping","Jobs-to-be-Done (JTBD)","Hypothesis-Driven Development","Product Roadmap Planning","Backlog Prioritization","Leadership","Beta Program Management","Continuous Improvement","Agile Mentorship","Startup Environment Navigation","Global Program Management","SaaS Implementation (Thomson Reuters)","Platform Configuration","Technical Architecture","SDLC Management","Subject Matter Expertise (Taxation)","SDLC Facilitation","Business Intelligence Migration (Cognos)","SOX Compliance","High-Availability Systems","Project Management","Project Planning","Roadmap Planning","Jira","Confluence","Smartsheet","Tableau","SQL","Oracle ERP","SaaS Implementation","AWS","Python","Vendor Management","Vendor/Partner Management (Banking)","UAT Management","QA & UAT Management","Beta Testing","System Integration (Oracle EBS)","Multi-System Integration (SaaS-SaaS-ERP)","API Integration (Hugging Face, Pinterest)","SaaS Platform Configuration (utm.io)"]};

// --- MASTER PROMPT TEMPLATE ---
const getMasterPrompt = (mode, jobDescription, resumeText) => {
    if (mode === 'resume') {
        return `You are an advanced AI resume tailoring engine. Based on the provided Master Profile Database and the Job Description, create a perfectly tailored resume.
**//-- START OF PROCESS --//**
**1. GIVEN:**
   - **The \`Master Profile Database\`:** ${JSON.stringify(masterProfile)}
   - **The \`Job Description\`:** \`\`\`${jobDescription}\`\`\`
**2. EXECUTE:**
   - Analyze the job description to create a blueprint.
   - Score and select the most relevant accomplishments from the database.
   - Generate a new professional summary and core competencies section.
   - Rewrite the selected accomplishment summaries following these strict rules:
     - **Tone:** Match the job description's tone.
     - **Structure:** \`[Result/Quantifiable Metric]\` -> \`by [Task/Action]\` -> \`[Outcome/Business Objective/Method]\`.
     - **Clarity & Length:** Use simple language, max two lines per bullet.
   - Assemble the final resume in Markdown with the correct bullet counts (RH:5, LM:3, AK:5).
   - Verify for 100% accuracy against the source data. No hallucinations.
**//-- END OF PROCESS --//**
**EXPECTED OUTPUT:** A complete, tailored resume in Markdown format, starting with the name.`;
    }
    if (mode === 'analyze') { return `Analyze the following job description and produce a structured JSON "Blueprint" containing: \`targetRole\`, \`top5HardSkills\`, \`top3CulturalTraits\`, \`writingStyle\`, and \`coreProblem\`. \n\n**Job Description:**\n\`\`\`${jobDescription}\`\`\``; }
    if (mode === 'coverLetter') { return `You are a professional career coach. Based on the provided Job Description and the candidate's Tailored Resume, write a concise and professional cover letter. It should be 3-4 paragraphs. Highlight 2-3 of the most relevant accomplishments from the resume and connect them directly to the job's core requirements. Maintain a confident but humble tone. Address it to the 'Hiring Team'.\n**Job Description:** \`\`\`${jobDescription}\`\`\`\n**Tailored Resume:** \`\`\`${resumeText}\`\`\``; }
    if (mode === 'interviewPrep') { return `You are the hiring manager for the role in the Job Description below. You are preparing to interview the candidate whose resume is also provided. Generate a list of 6 insightful interview questions. Include a mix of behavioral questions (using the STAR method format) and questions that probe their technical and program management experience. The questions should be specific to the resume and the job requirements.\n**Job Description:** \`\`\`${jobDescription}\`\`\`\n**Tailored Resume:** \`\`\`${resumeText}\`\`\``; }
    return '';
};


// --- SERVERLESS FUNCTION HANDLER ---
exports.handler = async function (event, context) {
    if (event.httpMethod !== 'POST') {
        return { statusCode: 405, body: 'Method Not Allowed' };
    }

    try {
        // The masterProfile is no longer received from the client.
        const { mode, jobDescription, resumeText } = JSON.parse(event.body);
        const apiKey = process.env.GEMINI_API_KEY;

        if (!apiKey) { throw new Error("API key is not configured."); }

        const prompt = getMasterPrompt(mode, jobDescription, resumeText);
        if (!prompt) { return { statusCode: 400, body: 'Invalid mode provided.' }; }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorBody = await response.text();
            console.error("API Error:", errorBody);
            return { statusCode: response.status, body: 'Error from Gemini API.' };
        }

        const result = await response.json();
        
        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
            return { statusCode: 200, body: result.candidates[0].content.parts[0].text };
        } else {
            return { statusCode: 500, body: 'Invalid response structure from API.' };
        }

    } catch (error) {
        console.error('Function Error:', error);
        return { statusCode: 500, body: JSON.stringify({ error: 'An internal error occurred.' }) };
    }
};